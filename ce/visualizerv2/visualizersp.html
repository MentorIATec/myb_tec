<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de Eventos V3 - Consejer√≠a Emocional</title>
    <style>
        /* Estilos base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --color-primary: #14387F;     /* Color principal azul marino MAE */
            --color-secondary: #D4AF37;   /* Color acento dorado/amarillo MAE */
            --color-tertiary: #55AADC;    /* Color azul celeste para botones */
            --color-light-bg: #EEF5FF;    /* Fondo claro con tinte azul */
            --color-primary-light: #D6E4FF; /* Fondo relacionado con color principal */
            --color-text-dark: #14387F;   /* Texto oscuro (azul marino) */
            --color-text-medium: #4A5568; /* Texto medio */
            --color-background: #ffffff;  /* Fondo blanco */
            
            /* Colores para tipos de eventos - mantener para preservar funcionalidad */
            --color-curso: #0072CE;
            --color-taller: #FF5800;
            --color-grupo: #9C27B0;
            --color-activacion: #009688;
            --color-evento: #FF9800;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f9fa;
            color: var(--color-text-dark);
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
        }
        
        h1 {
            font-size: 24px;
            color: var(--color-primary);
            margin-bottom: 20px;
            font-weight: 600;
            position: relative;
            padding-bottom: 10px;
        }
        
        h1::after {
            content: '';
            position: absolute;
            width: 60px;
            height: 3px;
            background: var(--color-secondary);
            bottom: 0;
            left: 0;
            border-radius: 3px;
        }
        
        .periodo-actual {
            background: var(--color-light-bg);
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 15px;
            color: var(--color-text-medium);
            text-align: center;
            border-left: 4px solid var(--color-primary);
        }
        
        .periodo-actual strong {
            color: var(--color-primary);
        }
        
        /* Calendario */
        .calendario-wrapper {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            border: 1px solid var(--color-primary-light);
        }
        
        .calendario-header {
            background: var(--color-primary);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .calendario-title {
            font-size: 20px;
            font-weight: 600;
        }
        
        .calendario-nav {
            display: flex;
            gap: 10px;
        }
        
        .calendario-nav-button {
            background: rgba(255,255,255,0.2);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.3s ease;
            color: white;
            font-size: 16px;
        }
        
        .calendario-nav-button:hover {
            background: rgba(255,255,255,0.3);
        }
        
        /* Contenedor de dos semanas */
        .calendario-dos-semanas {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 15px;
        }
        
        .calendario-semana {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
        }
        
        .calendario-day-header {
            text-align: center;
            font-weight: 600;
            color: var(--color-text-medium);
            font-size: 14px;
            padding: 8px 0;
        }
        
        .calendario-day {
            border-radius: 8px;
            padding: 8px 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            transition: all 0.3s ease;
            position: relative;
            cursor: pointer;
            min-height: 64px;
            background: #f9f9f9;
            box-sizing: border-box;
        }
        
        .calendario-day:hover {
            background: var(--color-light-bg);
        }
        
        .calendario-day-number {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 5px;
            text-align: right;
            width: 100%;
            padding-right: 5px;
        }
        
        .calendario-day-events {
            display: flex;
            flex-direction: column;
            gap: 2px;
            width: 100%;
        }
        
        .calendario-day.has-events {
            border: 1px solid var(--color-primary-light);
            background: var(--color-light-bg);
        }
        
        .calendario-day.has-events:hover {
            background: var(--color-primary-light);
        }
        
        .calendario-day.today {
            background: var(--color-primary-light);
            border: 2px solid var(--color-primary);
        }
        
        .calendario-day.other-month {
            background: #f2f2f2;
            opacity: 0.6;
        }
        
        /* Estilos para eventos en d√≠a */
        .day-event {
            font-size: 11px;
            padding: 2px 4px;
            margin: 1px 0;
            border-radius: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            cursor: pointer;
            color: white;
            text-align: center;
            width: 95%;
            margin-left: auto;
            margin-right: auto;
        }
        
        .day-event.curso { background-color: var(--color-curso); }
        .day-event.taller { background-color: var(--color-taller); }
        .day-event.grupo { background-color: var(--color-grupo); }
        .day-event.activacion { background-color: var(--color-activacion); }
        .day-event.evento { background-color: var(--color-evento); }
        .day-event.otro { background-color: #777777; }
        
        /* Lista de eventos pr√≥ximos */
        .events-container {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            margin-bottom: 20px;
            border: 1px solid var(--color-primary-light);
        }
        
        .events-header {
            background: var(--color-primary);
            color: white;
            padding: 15px 20px;
        }
        
        .events-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .events-list {
            padding: 15px;
        }
        
        .event-card {
            border-left: 3px solid var(--color-primary);
            padding: 12px;
            margin-bottom: 12px;
            background: var(--color-light-bg);
            border-radius: 0 8px 8px 0;
        }
        
        .event-card:last-child {
            margin-bottom: 0;
        }
        
        .event-card.curso { border-left-color: var(--color-curso); }
        .event-card.taller { border-left-color: var(--color-taller); }
        .event-card.grupo { border-left-color: var(--color-grupo); }
        .event-card.activacion { border-left-color: var(--color-activacion); }
        .event-card.evento { border-left-color: var(--color-evento); }
        
        .event-fecha {
            font-size: 12px;
            font-weight: 500;
            color: #666;
            margin-bottom: 4px;
        }
        
        .event-card-title {
            font-weight: bold;
            font-size: 15px;
            margin-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .event-card.curso .event-card-title { color: var(--color-curso); }
        .event-card.taller .event-card-title { color: var(--color-taller); }
        .event-card.grupo .event-card-title { color: var(--color-grupo); }
        .event-card.activacion .event-card-title { color: var(--color-activacion); }
        .event-card.evento .event-card-title { color: var(--color-evento); }
        
        .event-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            text-transform: uppercase;
        }
        
        .event-badge.curso { background: rgba(0, 114, 206, 0.2); color: var(--color-curso); }
        .event-badge.taller { background: rgba(255, 88, 0, 0.2); color: var(--color-taller); }
        .event-badge.grupo { background: rgba(156, 39, 176, 0.2); color: var(--color-grupo); }
        .event-badge.activacion { background: rgba(0, 150, 136, 0.2); color: var(--color-activacion); }
        .event-badge.evento { background: rgba(255, 152, 0, 0.2); color: var(--color-evento); }
        
        .event-info {
            display: flex;
            gap: 15px;
            font-size: 13px;
            margin-bottom: 8px;
            color: #555;
        }
        
        .event-time, .event-location {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .event-btn {
            display: inline-block;
            margin-top: 8px;
            margin-right: 10px;
            text-decoration: none;
            font-weight: 500;
            font-size: 13px;
            color: var(--color-tertiary);
        }
        
        .event-btn:hover {
            text-decoration: underline;
        }
        
        .event-btn.calendar-btn {
            color: var(--color-curso);
        }
        
        /* Leyenda */
        .leyenda-container {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            flex-wrap: wrap;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.08);
            border: 1px solid var(--color-primary-light);
        }
        
        .leyenda-item {
            display: flex;
            align-items: center;
            font-size: 14px;
            color: var(--color-text-medium);
        }
        
        .leyenda-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .leyenda-dot.curso { background: var(--color-curso); }
        .leyenda-dot.taller { background: var(--color-taller); }
        .leyenda-dot.grupo { background: var(--color-grupo); }
        .leyenda-dot.activacion { background: var(--color-activacion); }
        .leyenda-dot.evento { background: var(--color-evento); }
        
        /* Modal para detalles de evento */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        
        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            background: none;
            border: none;
        }
        
        .modal-close:hover {
            color: var(--color-secondary);
        }
        
        .modal-title {
            color: var(--color-primary);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--color-primary-light);
        }
        
        /* Estados de carga y error */
        .loading {
            text-align: center;
            padding: 30px;
            color: var(--color-text-medium);
            font-style: italic;
        }
        
        .loading::before {
            content: "";
            display: block;
            width: 40px;
            height: 40px;
            margin: 0 auto 15px;
            border: 3px solid var(--color-primary-light);
            border-radius: 50%;
            border-top-color: var(--color-primary);
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error-message {
            text-align: center;
            padding: 20px;
            background: #FFF3F0;
            color: #D32F2F;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 0 10px;
                margin: 15px auto;
            }
            
            h1 {
                font-size: 20px;
                text-align: center;
                margin-bottom: 15px;
            }
            
            h1::after {
                left: 50%;
                transform: translateX(-50%);
            }
            
            .periodo-actual {
                font-size: 14px;
                padding: 10px;
                margin-bottom: 10px;
            }
            
            .calendario-title {
                font-size: 16px;
            }
            
            .calendario-day {
                min-height: 48px;
                padding: 4px 1px;
            }
            
            .calendario-day-number {
                font-size: 13px;
                margin-bottom: 2px;
            }
            
            .day-event {
                font-size: 9px;
            }
            
            .event-card-title {
                font-size: 14px;
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
            
            .event-info {
                flex-direction: column;
                gap: 5px;
            }
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 0 5px;
                margin: 10px auto;
            }
            
            .calendario-dos-semanas {
                padding: 8px;
                gap: 8px;
            }
            
            .calendario-semana {
                gap: 4px;
            }
            
            .calendario-day {
                min-height: 40px;
                padding: 2px 0;
            }
            
            .calendario-day-number {
                font-size: 11px;
                margin-bottom: 1px;
            }
            
            .day-event {
                font-size: 8px;
                padding: 1px 2px;
            }
            
            .evento-dot {
                width: 4px;
                height: 4px;
            }
            
            .calendario-nav-button {
                min-width: 36px;
                min-height: 36px;
            }
            
            .calendario-day.today {
                border-width: 1px;
            }
        }
        
        /* Optimizaciones espec√≠ficas para iframe en SharePoint */
        @media (max-width: 800px) and (min-width: 481px) {
            .container {
                padding: 8px;
            }
            
            h1 {
                font-size: 20px;
            }
            
            .calendario-day {
                min-height: 55px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Visualizador de Eventos - Consejer√≠a Emocional</h1>
        
        <div class="periodo-actual">
            Mostrando eventos para <strong id="periodo-actual-texto">las pr√≥ximas dos semanas</strong>
        </div>
        
        <!-- Calendario -->
        <div class="calendario-wrapper">
            <div class="calendario-header">
                <div class="calendario-title" id="calendario-mes-actual">Marzo 2025</div>
                <div class="calendario-nav">
                    <button class="calendario-nav-button" id="periodo-anterior">&lt;</button>
                    <button class="calendario-nav-button" id="periodo-siguiente">&gt;</button>
                </div>
            </div>
            
            <div class="calendario-dos-semanas">
                <!-- Semana 1 - Headers -->
                <div class="calendario-semana">
                    <div class="calendario-day-header">LUN</div>
                    <div class="calendario-day-header">MAR</div>
                    <div class="calendario-day-header">MI√â</div>
                    <div class="calendario-day-header">JUE</div>
                    <div class="calendario-day-header">VIE</div>
                </div>
                <!-- Semana 1 - D√≠as (se llenar√°n mediante JavaScript) -->
                <div class="calendario-semana" id="semana-1">
                    <div class="loading" style="grid-column: span 5;">Cargando calendario...</div>
                </div>
                <!-- Semana 2 - D√≠as (se llenar√°n mediante JavaScript) -->
                <div class="calendario-semana" id="semana-2">
                </div>
            </div>
        </div>
        
        <!-- Leyenda de colores -->
        <div class="leyenda-container">
            <div class="leyenda-item">
                <div class="leyenda-dot curso"></div>
                <span>Cursos</span>
            </div>
            <div class="leyenda-item">
                <div class="leyenda-dot taller"></div>
                <span>Talleres</span>
            </div>
            <div class="leyenda-item">
                <div class="leyenda-dot grupo"></div>
                <span>Grupos</span>
            </div>
            <div class="leyenda-item">
                <div class="leyenda-dot activacion"></div>
                <span>Activaciones</span>
            </div>
            <div class="leyenda-item">
                <div class="leyenda-dot evento"></div>
                <span>Eventos</span>
            </div>
        </div>
        
        <!-- Lista de eventos pr√≥ximos -->
        <div class="events-container">
            <div class="events-header">
                <div class="events-title">Eventos pr√≥ximos</div>
            </div>
            
            <div class="events-list" id="events-list">
                <!-- Los eventos se cargar√°n aqu√≠ din√°micamente -->
                <div class="loading">Cargando eventos pr√≥ximos...</div>
            </div>
        </div>
    </div>
    
    <!-- Modal para ver detalles de los eventos -->
    <div class="modal" id="event-modal">
        <div class="modal-content">
            <button class="modal-close" id="modal-close">&times;</button>
            <h3 class="modal-title" id="modal-title">Detalles del evento</h3>
            <div class="modal-body" id="modal-body">
                <!-- El contenido del modal se cargar√° din√°micamente -->
            </div>
        </div>
    </div>
    
    <script>
        // Ajustar el iframe en SharePoint si es necesario
        (function() {
            // Detectar si estamos en un iframe
            if (window.self !== window.top) {
                // Estamos en un iframe, posiblemente en SharePoint
                document.addEventListener('DOMContentLoaded', function() {
                    // Iniciar la comunicaci√≥n con el padre para ajustar la altura
                    setInterval(function() {
                        const height = document.body.scrollHeight;
                        window.parent.postMessage({ height: height }, '*');
                    }, 500);
                });
            }
        })();
        
        // URL para cargar los eventos - NO MODIFICAR
        const eventsUrl = 'https://karenguzmn.github.io/myb_tec/ce/eventos.json';
        
        // Variables para seguimiento del estado
        let allEvents = [];
        let fechaInicioPeriodo = new Date();
        
        // Nombres de meses en espa√±ol
        const nombresMeses = [
            'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
            'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
        ];
        
        // Referencias a elementos DOM
        const semana1 = document.getElementById('semana-1');
        const semana2 = document.getElementById('semana-2');
        const calendarioMesActual = document.getElementById('calendario-mes-actual');
        const periodoActualTexto = document.getElementById('periodo-actual-texto');
        const periodoAnterior = document.getElementById('periodo-anterior');
        const periodoSiguiente = document.getElementById('periodo-siguiente');
        const eventsList = document.getElementById('events-list');
        const eventModal = document.getElementById('event-modal');
        const modalClose = document.getElementById('modal-close');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        
        // Inicializar la aplicaci√≥n
        document.addEventListener('DOMContentLoaded', () => {
            try {
                // Ajustar fecha de inicio al lunes de la semana actual
                ajustarFechaInicioPeriodo();
                
                // Cargar eventos
                fetchEvents();
                
                // Configurar listeners
                periodoAnterior.addEventListener('click', irPeriodoAnterior);
                periodoSiguiente.addEventListener('click', irPeriodoSiguiente);
                modalClose.addEventListener('click', cerrarModal);
                
                // Cerrar modal al hacer clic fuera o con ESC
                eventModal.addEventListener('click', (e) => {
                    if (e.target === eventModal) cerrarModal();
                });
                
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') cerrarModal();
                });
            } catch (error) {
                console.error('Error en inicializaci√≥n:', error);
                if (semana1) {
                    semana1.innerHTML = `<div style="grid-column: span 5; padding: 20px; text-align: center;" class="error-message">Error al inicializar calendario. (${error.message})</div>`;
                }
                if (semana2) {
                    semana2.innerHTML = '';
                }
            }
        });
        
        // Ajustar fecha de inicio al lunes de la semana actual
        function ajustarFechaInicioPeriodo() {
            const hoy = new Date();
            const diaSemana = hoy.getDay(); // 0 = domingo, 1 = lunes, ..., 6 = s√°bado
            
            // Si es domingo, comenzar desde el lunes siguiente
            // Si no, retroceder hasta el lunes de la semana actual
            const diasAtras = diaSemana === 0 ? -6 : (diaSemana - 1);
            
            fechaInicioPeriodo = new Date(hoy);
            fechaInicioPeriodo.setDate(hoy.getDate() - diasAtras);
            
            // Ajustar a inicio del d√≠a
            fechaInicioPeriodo.setHours(0, 0, 0, 0);
        }
        
        // Cargar eventos desde JSON
        function fetchEvents() {
            fetch(eventsUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (!data || !data.eventos || !Array.isArray(data.eventos)) {
                        throw new Error('Formato de datos inv√°lido');
                    }
                    
                    // Procesar eventos
                    allEvents = data.eventos.map(event => {
                        return {
                            ...event,
                            fechaInicio: parseDate(event.fechaInicio),
                            fechaFin: parseDate(event.fechaFin || event.fechaInicio),
                            categoria: normalizeCategory(event.categoria)
                        };
                    });
                    
                    // Generar calendario
                    generarCalendarioDosSemanasDesde(fechaInicioPeriodo);
                    
                    // Mostrar eventos pr√≥ximos
                    mostrarEventosProximos();
                })
                .catch(error => {
                    console.error('Error fetching events:', error);
                    if (semana1) {
                        semana1.innerHTML = `<div style="grid-column: span 5; padding: 20px; text-align: center;" class="error-message">Error al cargar eventos. Por favor, intenta de nuevo m√°s tarde.</div>`;
                    }
                    if (semana2) {
                        semana2.innerHTML = '';
                    }
                    if (eventsList) {
                        eventsList.innerHTML = `<div class="error-message">Error al cargar eventos. Por favor, intenta de nuevo m√°s tarde.</div>`;
                    }
                });
        }
        
        // Parsear fecha desde formato DD/MM/YYYY
        function parseDate(dateStr) {
            if (!dateStr) return null;
            
            // Si ya es un objeto Date, devolverlo
            if (dateStr instanceof Date) return dateStr;
            
            try {
                const parts = dateStr.split('/');
                
                if (parts.length === 3) {
                    // Formato DD/MM/YYYY
                    const day = parseInt(parts[0], 10);
                    const month = parseInt(parts[1], 10) - 1; // Meses van de 0-11 en JS
                    const year = parseInt(parts[2], 10);
                    
                    return new Date(year, month, day);
                }
                
                // Intentar con formato de fecha normal
                return new Date(dateStr);
            } catch (error) {
                console.error('Error parsing date:', dateStr, error);
                return null;
            }
        }
        
        // Normalizar categor√≠a
        function normalizeCategory(category) {
            if (!category) return 'otro';
            
            // Primero intentar obtener la categor√≠a exacta
            const cat = (category || '').toString().toLowerCase().trim();
            
            if (cat === 'taller') return 'taller';
            if (cat === 'curso') return 'curso'; 
            if (cat === 'grupo') return 'grupo';
            if (cat === 'activacion' || cat === 'activaci√≥n') return 'activacion';
            if (cat === 'evento') return 'evento';
            
            // Si no coincide exactamente, buscar en el texto
            if (cat.includes('taller')) return 'taller';
            if (cat.includes('curso')) return 'curso';
            if (cat.includes('grupo')) return 'grupo';
            if (cat.includes('activacion') || cat.includes('activaci√≥n')) return 'activacion';
            if (cat.includes('evento')) return 'evento';
            
            return 'otro';
        }
        
        // Formatear fecha corta (similar a MAES)
        function formatShortDate(date) {
            const options = { day: 'numeric', month: 'short' };
            return date.toLocaleDateString('es-ES', options);
        }
        
        // Generar calendario para dos semanas a partir de una fecha dada
        function generarCalendarioDosSemanasDesde(fechaInicio) {
            // Crear copias de la fecha para manipular
            const inicioSemana1 = new Date(fechaInicio);
            const inicioSemana2 = new Date(fechaInicio);
            inicioSemana2.setDate(inicioSemana1.getDate() + 7);
            
            // Actualizar el t√≠tulo del per√≠odo
            actualizarTituloPeriodo(inicioSemana1);
            
            // Generar cada semana
            generarSemana(inicioSemana1, 'semana-1');
            generarSemana(inicioSemana2, 'semana-2');
        }
        
        // Actualizar el t√≠tulo del per√≠odo
        function actualizarTituloPeriodo(fechaInicio) {
            const fechaFin = new Date(fechaInicio);
            fechaFin.setDate(fechaInicio.getDate() + 13); // 14 d√≠as (2 semanas)
            
            // Si el per√≠odo cruza meses diferentes
            if (fechaInicio.getMonth() !== fechaFin.getMonth()) {
                calendarioMesActual.textContent = 
                    `${nombresMeses[fechaInicio.getMonth()]} - ${nombresMeses[fechaFin.getMonth()]} ${fechaFin.getFullYear()}`;
            } else {
                calendarioMesActual.textContent = 
                    `${nombresMeses[fechaInicio.getMonth()]} ${fechaInicio.getFullYear()}`;
            }
            
            // Actualizar texto del per√≠odo
            periodoActualTexto.textContent = 
                `${formatShortDate(fechaInicio)} al ${formatShortDate(fechaFin)}`;
        }
        
        // Generar una semana del calendario
        function generarSemana(fechaInicio, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = '';
            
            // Crear copia de la fecha para manipular
            const fechaActual = new Date(fechaInicio);
            
            // Fecha actual para identificar "hoy"
            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);
            
            // Crear los 5 d√≠as de la semana (Lu-Vi)
            for (let i = 0; i < 5; i++) {
                const esHoy = fechaActual.getTime() === hoy.getTime();
                const esOtroMes = fechaActual.getMonth() !== fechaInicio.getMonth();
                
                // Verificar si hay eventos para este d√≠a
                const eventosDelDia = getEventsForDay(fechaActual);
                
                // Crear la celda del d√≠a
                const diaElement = document.createElement('div');
                diaElement.className = 'calendario-day';
                if (esHoy) diaElement.classList.add('today');
                if (esOtroMes) diaElement.classList.add('other-month');
                if (eventosDelDia.length > 0) diaElement.classList.add('has-events');
                
                // Guardar la fecha como atributo data para usar al hacer clic
                diaElement.setAttribute('data-fecha', formatDateForAttribute(fechaActual));
                
                // Agregar n√∫mero del d√≠a
                const diaNumero = document.createElement('div');
                diaNumero.className = 'calendario-day-number';
                diaNumero.textContent = fechaActual.getDate();
                diaElement.appendChild(diaNumero);
                
                // Agregar eventos del d√≠a
                if (eventosDelDia.length > 0) {
                    const eventosContainer = document.createElement('div');
                    eventosContainer.className = 'calendario-day-events';
                    
                    // Agrupar eventos por categor√≠a para mostrar un indicador por categor√≠a
                    const eventsByCategory = {};
                    
                    eventosDelDia.forEach(event => {
                        const categoria = event.categoria || 'otro';
                        if (!eventsByCategory[categoria]) {
                            eventsByCategory[categoria] = [];
                        }
                        eventsByCategory[categoria].push(event);
                    });
                    
                    // Mostrar los eventos agrupados por categor√≠a
                    for (const category in eventsByCategory) {
                        const count = eventsByCategory[category].length;
                        
                        const eventIndicator = document.createElement('div');
                        eventIndicator.className = `day-event ${category}`;
                        eventIndicator.textContent = `${count} ${category}${count > 1 ? 's' : ''}`;
                        
                        eventosContainer.appendChild(eventIndicator);
                    }
                    
                    diaElement.appendChild(eventosContainer);
                    
                    // Agregar evento de clic para mostrar todos los eventos del d√≠a
                    diaElement.addEventListener('click', () => mostrarEventosDelDia(fechaActual, eventosDelDia));
                }
                
                // Agregar al contenedor
                container.appendChild(diaElement);
                
                // Avanzar al siguiente d√≠a
                fechaActual.setDate(fechaActual.getDate() + 1);
            }
        }
        
        // Obtener eventos para un d√≠a espec√≠fico
        function getEventsForDay(date) {
            if (!allEvents || !date) return [];
            
            return allEvents.filter(event => {
                // Eventos sin fecha no se muestran
                if (!event.fechaInicio) return false;
                
                // Si el evento es del mismo d√≠a
                if (isSameDay(event.fechaInicio, date)) return true;
                
                // Si el evento tiene fecha de fin y la fecha est√° en el rango
                if (event.fechaFin && 
                    date >= event.fechaInicio && 
                    date <= event.fechaFin) {
                    return true;
                }
                
                return false;
            });
        }
        
        // Verificar si dos fechas son el mismo d√≠a
        function isSameDay(date1, date2) {
            if (!date1 || !date2) return false;
            
            return date1.getDate() === date2.getDate() &&
                   date1.getMonth() === date2.getMonth() &&
                   date1.getFullYear() === date2.getFullYear();
        }
        
        // Formatear fecha completa
        function formatDate(date) {
            if (!date) return 'Fecha no disponible';
            
            const options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
            return date.toLocaleDateString('es-ES', options);
        }
        
        // Formatear fecha para atributo data (YYYY-MM-DD)
        function formatDateForAttribute(date) {
            if (!date) return '';
            
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            
            return `${year}-${month}-${day}`;
        }
        
        // Mostrar eventos pr√≥ximos
        function mostrarEventosProximos() {
            // Limpiar lista
            if (!eventsList) return;
            eventsList.innerHTML = '';
            
            // Obtener fecha actual (inicio del d√≠a)
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            // Filtrar eventos futuros
            const proximosEventos = allEvents.filter(event => {
                if (!event.fechaInicio) return false;
                return event.fechaInicio >= today;
            });
            
            // Ordenar por fecha
            proximosEventos.sort((a, b) => {
                if (!a.fechaInicio || !b.fechaInicio) return 0;
                return a.fechaInicio - b.fechaInicio;
            });
            
            // Si no hay eventos pr√≥ximos
            if (proximosEventos.length === 0) {
                eventsList.innerHTML = '<div style="text-align:center; padding:20px; color:#666;">No hay eventos pr√≥ximos programados.</div>';
                return;
            }
            
            // Mostrar los primeros 5 eventos pr√≥ximos
            const eventosAMostrar = proximosEventos.slice(0, 5);
            
            eventosAMostrar.forEach(event => {
                const eventCard = crearEventCard(event);
                eventsList.appendChild(eventCard);
            });
        }
        
        // Crear tarjeta de evento
        function crearEventCard(event) {
            const card = document.createElement('div');
            card.className = `event-card ${event.categoria}`;
            
            // Fecha formateada
            const fechaFormateada = formatDate(event.fechaInicio);
            
            // Fecha
            const fechaElement = document.createElement('div');
            fechaElement.className = 'event-fecha';
            fechaElement.textContent = fechaFormateada;
            
            // T√≠tulo y badge
            const titleContainer = document.createElement('div');
            titleContainer.className = 'event-card-title';
            
            const title = document.createElement('span');
            title.textContent = event.titulo;
            
            const badge = document.createElement('span');
            badge.className = `event-badge ${event.categoria}`;
            badge.textContent = capitalizeFirstLetter(event.categoria);
            
            titleContainer.appendChild(title);
            titleContainer.appendChild(badge);
            
            // Informaci√≥n del evento
            const eventInfo = document.createElement('div');
            eventInfo.className = 'event-info';
            
            const timeInfo = document.createElement('div');
            timeInfo.className = 'event-time';
            timeInfo.innerHTML = `<span>‚è∞</span> ${event.horario || 'Horario por definir'}`;
            
            const locationInfo = document.createElement('div');
            locationInfo.className = 'event-location';
            locationInfo.innerHTML = `<span>üìç</span> ${event.ubicacion || event.ubicaci√≥n || 'Ubicaci√≥n por definir'}`;
            
            eventInfo.appendChild(timeInfo);
            eventInfo.appendChild(locationInfo);
            
            // Acciones
            const actions = document.createElement('div');
            actions.style.display = 'flex';
            actions.style.flexWrap = 'wrap';
            
            // Bot√≥n de registro (si tiene URL)
            if (event.urlRegistro && event.urlRegistro !== '#') {
                const registerBtn = document.createElement('a');
                registerBtn.href = event.urlRegistro;
                registerBtn.target = '_blank';
                registerBtn.className = 'event-btn';
                registerBtn.textContent = 'Inscribirme ‚Üí';
                actions.appendChild(registerBtn);
            }
            
            // Bot√≥n para agregar al calendario
            const calendarBtn = document.createElement('a');
            calendarBtn.href = '#';
            calendarBtn.className = 'event-btn calendar-btn';
            calendarBtn.textContent = 'A√±adir a calendario';
            calendarBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                generateICS(event);
            });
            actions.appendChild(calendarBtn);
            
            // Armar la tarjeta
            card.appendChild(fechaElement);
            card.appendChild(titleContainer);
            card.appendChild(eventInfo);
            card.appendChild(actions);
            
            // Agregar evento de clic para mostrar detalles
            card.addEventListener('click', () => mostrarDetallesEvento(event));
            
            return card;
        }
        
        // Mostrar eventos de un d√≠a en el modal
        function mostrarEventosDelDia(fecha, eventos) {
            // Actualizar t√≠tulo
            modalTitle.textContent = `Eventos para el ${formatDate(fecha)}`;
            
            // Limpiar contenido
            modalBody.innerHTML = '';
            
            // Ordenar eventos por hora
            const eventosOrdenados = [...eventos].sort((a, b) => {
                if (!a.horario || !b.horario) return 0;
                return a.horario.localeCompare(b.horario);
            });
            
            // Si no hay eventos
            if (eventosOrdenados.length === 0) {
                modalBody.innerHTML = '<div style="text-align:center; padding:10px; color:#666;">No hay eventos programados para este d√≠a.</div>';
            } else {
                // Crear elementos para cada evento
                eventosOrdenados.forEach(event => {
                    const eventItem = document.createElement('div');
                    eventItem.className = `event-card ${event.categoria}`;
                    eventItem.style.marginBottom = '10px';
                    
                    // T√≠tulo
                    const title = document.createElement('div');
                    title.className = 'event-card-title';
                    title.innerHTML = `
                        <span>${event.titulo}</span>
                        <span class="event-badge ${event.categoria}">${capitalizeFirstLetter(event.categoria)}</span>
                    `;
                    
                    // Informaci√≥n
                    const info = document.createElement('div');
                    info.className = 'event-info';
                    info.innerHTML = `
                        <div class="event-time"><span>‚è∞</span> ${event.horario || 'Horario por definir'}</div>
                        <div class="event-location"><span>üìç</span> ${event.ubicacion || event.ubicaci√≥n || 'Ubicaci√≥n por definir'}</div>
                    `;
                    
                    // Descripci√≥n (si existe)
                    if (event.descripcion) {
                        const desc = document.createElement('div');
                        desc.style.margin = '10px 0';
                        desc.style.fontSize = '13px';
                        desc.style.color = '#444';
                        desc.textContent = event.descripcion;
                        info.appendChild(desc);
                    }
                    
                    // Acciones
                    const actions = document.createElement('div');
                    actions.style.marginTop = '10px';
                    actions.style.display = 'flex';
                    actions.style.flexWrap = 'wrap';
                    
                    // Bot√≥n de registro (si tiene URL)
                    if (event.urlRegistro && event.urlRegistro !== '#') {
                        const registerBtn = document.createElement('a');
                        registerBtn.href = event.urlRegistro;
                        registerBtn.target = '_blank';
                        registerBtn.className = 'event-btn';
                        registerBtn.textContent = 'Inscribirme ‚Üí';
                        actions.appendChild(registerBtn);
                    }
                    
                    // Bot√≥n para agregar al calendario
                    const calendarBtn = document.createElement('a');
                    calendarBtn.href = '#';
                    calendarBtn.className = 'event-btn calendar-btn';
                    calendarBtn.textContent = 'A√±adir a calendario';
                    calendarBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        generateICS(event);
                    });
                    actions.appendChild(calendarBtn);
                    
                    eventItem.appendChild(title);
                    eventItem.appendChild(info);
                    eventItem.appendChild(actions);
                    
                    modalBody.appendChild(eventItem);
                });
            }
            
            // Mostrar modal
            eventModal.style.display = 'flex';
        }
        
        // Mostrar detalles de un evento
        function mostrarDetallesEvento(event) {
            // Actualizar t√≠tulo
            modalTitle.textContent = event.titulo;
            
            // Limpiar contenido
            modalBody.innerHTML = '';
            
            // Crear contenido
            const content = document.createElement('div');
            
            // Badge de categor√≠a
            const categoryBadge = document.createElement('div');
            categoryBadge.className = `event-badge ${event.categoria}`;
            categoryBadge.style.marginBottom = '15px';
            categoryBadge.textContent = capitalizeFirstLetter(event.categoria);
            content.appendChild(categoryBadge);
            
            // Informaci√≥n b√°sica
            const basicInfo = document.createElement('div');
            basicInfo.style.marginBottom = '20px';
            
            // Fecha
            const dateInfo = document.createElement('div');
            dateInfo.style.marginBottom = '10px';
            dateInfo.innerHTML = `<strong>üìÖ Fecha:</strong> ${formatDate(event.fechaInicio)}`;
            
            // Si tiene fecha fin diferente, mostrarla
            if (event.fechaFin && !isSameDay(event.fechaInicio, event.fechaFin)) {
                dateInfo.innerHTML += ` - ${formatDate(event.fechaFin)}`;
            }
            
            basicInfo.appendChild(dateInfo);
            
            // Horario
            const timeInfo = document.createElement('div');
            timeInfo.style.marginBottom = '10px';
            timeInfo.innerHTML = `<strong>‚è∞ Horario:</strong> ${event.horario || 'No especificado'}`;
            basicInfo.appendChild(timeInfo);
            
            // Ubicaci√≥n
            const locationInfo = document.createElement('div');
            locationInfo.style.marginBottom = '10px';
            locationInfo.innerHTML = `<strong>üìç Ubicaci√≥n:</strong> ${event.ubicacion || event.ubicaci√≥n || 'No especificada'}`;
            basicInfo.appendChild(locationInfo);
            
            // Modalidad (si existe)
            if (event.modalidad) {
                const modalityInfo = document.createElement('div');
                modalityInfo.style.marginBottom = '10px';
                modalityInfo.innerHTML = `<strong>üîÑ Modalidad:</strong> ${event.modalidad}`;
                basicInfo.appendChild(modalityInfo);
            }
            
            content.appendChild(basicInfo);
            
            // Descripci√≥n
            if (event.descripcion) {
                const descTitle = document.createElement('h4');
                descTitle.style.marginBottom = '10px';
                descTitle.style.color = '#333';
                descTitle.textContent = 'Descripci√≥n';
                content.appendChild(descTitle);
                
                const descText = document.createElement('p');
                descText.style.marginBottom = '20px';
                descText.style.color = '#444';
                descText.style.lineHeight = '1.5';
                descText.textContent = event.descripcion;
                content.appendChild(descText);
            }
            
            // Acciones
            const actions = document.createElement('div');
            actions.style.marginTop = '20px';
            actions.style.display = 'flex';
            actions.style.flexWrap = 'wrap';
            
            // Bot√≥n de registro (si tiene URL)
            if (event.urlRegistro && event.urlRegistro !== '#') {
                const registerBtn = document.createElement('a');
                registerBtn.href = event.urlRegistro;
                registerBtn.target = '_blank';
                registerBtn.className = 'event-btn';
                registerBtn.textContent = 'Inscribirme ‚Üí';
                actions.appendChild(registerBtn);
            }
            
            // Bot√≥n para agregar al calendario
            const calendarBtn = document.createElement('a');
            calendarBtn.href = '#';
            calendarBtn.className = 'event-btn calendar-btn';
            calendarBtn.textContent = 'A√±adir a calendario';
            calendarBtn.addEventListener('click', (e) => {
                e.preventDefault();
                generateICS(event);
            });
            actions.appendChild(calendarBtn);
            
            content.appendChild(actions);
            
            modalBody.appendChild(content);
            
            // Mostrar modal
            eventModal.style.display = 'flex';
        }
        
        // Funci√≥n para ir al per√≠odo anterior
        function irPeriodoAnterior() {
            const nuevaFecha = new Date(fechaInicioPeriodo);
            nuevaFecha.setDate(fechaInicioPeriodo.getDate() - 14); // Retroceder 2 semanas
            fechaInicioPeriodo = nuevaFecha;
            
            generarCalendarioDosSemanasDesde(fechaInicioPeriodo);
        }
        
        // Funci√≥n para ir al per√≠odo siguiente
        function irPeriodoSiguiente() {
            const nuevaFecha = new Date(fechaInicioPeriodo);
            nuevaFecha.setDate(fechaInicioPeriodo.getDate() + 14); // Avanzar 2 semanas
            fechaInicioPeriodo = nuevaFecha;
            
            generarCalendarioDosSemanasDesde(fechaInicioPeriodo);
        }
        
        // Cerrar modal
        function cerrarModal() {
            if (eventModal) {
                eventModal.style.display = 'none';
            }
        }
        
        // Capitalizar primera letra
        function capitalizeFirstLetter(string) {
            if (!string) return '';
            return string.charAt(0).toUpperCase() + string.slice(1);
        }
        
        // Generar archivo ICS para evento
        function generateICS(event) {
            try {
                // Crear fechas para el evento
                const startDate = event.fechaInicio;
                let endDate = event.fechaFin || new Date(startDate);
                
                // Si es el mismo d√≠a, agregar 1 hora por defecto
                if (isSameDay(startDate, endDate) && 
                    startDate.getHours() === endDate.getHours() && 
                    startDate.getMinutes() === endDate.getMinutes()) {
                    
                    // Intentar extraer hora del texto de horario
                    if (event.horario) {
                        const timeMatch = event.horario.match(/(\d{1,2}):(\d{2})/g);
                        
                        if (timeMatch && timeMatch.length >= 1) {
                            // Primer horario (inicio)
                            const [hour, minute] = timeMatch[0].split(':').map(Number);
                            startDate.setHours(hour, minute, 0);
                            
                            if (timeMatch.length >= 2) {
                                // Segundo horario (fin)
                                const [endHour, endMinute] = timeMatch[1].split(':').map(Number);
                                endDate.setHours(endHour, endMinute, 0);
                            } else {
                                // Si solo tenemos hora de inicio, agregar 1 hora
                                endDate = new Date(startDate);
                                endDate.setHours(endDate.getHours() + 1);
                            }
                        } else {
                            // Sin formato de hora reconocible, agregar 1 hora por defecto
                            endDate = new Date(startDate);
                            endDate.setHours(endDate.getHours() + 1);
                        }
                    } else {
                        // Sin informaci√≥n de horario, agregar 1 hora por defecto
                        endDate = new Date(startDate);
                        endDate.setHours(endDate.getHours() + 1);
                    }
                }
                
                // Formatear fechas para ICS
                const formatDateForICS = (date) => {
                    return date.toISOString().replace(/-|:|\.\d+/g, '');
                };
                
                // Crear contenido ICS
                const icsContent = [
                    'BEGIN:VCALENDAR',
                    'VERSION:2.0',
                    'PRODID:-//Consejer√≠a Emocional//Eventos//ES',
                    'CALSCALE:GREGORIAN',
                    'METHOD:PUBLISH',
                    'BEGIN:VEVENT',
                    `UID:${event.id || Math.random().toString(36).substring(2, 11)}@tecevents`,
                    `DTSTAMP:${formatDateForICS(new Date())}`,
                    `DTSTART:${formatDateForICS(startDate)}`,
                    `DTEND:${formatDateForICS(endDate)}`,
                    `SUMMARY:${event.titulo}`,
                    `DESCRIPTION:${event.descripcion || 'Sin descripci√≥n'}`,
                    `LOCATION:${event.ubicacion || event.ubicaci√≥n || 'No especificada'}`,
                    'END:VEVENT',
                    'END:VCALENDAR'
                ].join('\r\n');
                
                // Crear blob y URL
                const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                
                // Crear enlace y simular clic
                const link = document.createElement('a');
                link.href = url;
                link.download = `evento_${event.id || 'tec'}.ics`;
                document.body.appendChild(link);
                link.click();
                
                // Limpiar
                setTimeout(() => {
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                }, 100);
                
                alert('Evento a√±adido a tu calendario');
            } catch (error) {
                console.error('Error generando archivo ICS:', error);
                alert('No se pudo generar el archivo para calendario');
            }
        }
    </script>
</body>
</html>
