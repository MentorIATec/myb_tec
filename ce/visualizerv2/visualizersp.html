// Variables globales para almacenar datos
let todosLosEventos = [];
let mesActual = new Date().getMonth();
let anioActual = new Date().getFullYear();
let vistaActual = 'mes'; // 'mes' o 'dos-semanas'

// Nombres de los meses en espa√±ol
const nombresMeses = [
    'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
    'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
];

// Funci√≥n para formatear fechas
function formatDate(dateString, includeWeekday = true) {
    if (!dateString) return 'Fecha por definir';
    
    let fecha;
    // Verificar el formato de la fecha (DD/MM/YYYY)
    if (typeof dateString === 'string' && dateString.includes('/')) {
        const partes = dateString.split('/');
        if (partes.length === 3) {
            // En el JSON la fecha est√° en formato DD/MM/YYYY
            fecha = new Date(
                parseInt(partes[2]),       // a√±o
                parseInt(partes[1]) - 1,   // mes (0-11)
                parseInt(partes[0])        // d√≠a
            );
        } else {
            return 'Fecha inv√°lida';
        }
    } else if (dateString instanceof Date) {
        fecha = dateString;
    } else {
        fecha = new Date(dateString);
    }
    
    // Verificar si la fecha es v√°lida
    if (isNaN(fecha.getTime())) {
        return 'Fecha por definir';
    }
    
    const options = includeWeekday ? 
        { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' } : 
        { year: 'numeric', month: 'long', day: 'numeric' };
    
    return fecha.toLocaleDateString('es-ES', options);
}

// Funci√≥n para formatear fechas cortas
function formatShortDate(date) {
    const options = { day: 'numeric', month: 'short' };
    return date.toLocaleDateString('es-ES', options);
}

// Funci√≥n para parsear fecha de formato DD/MM/YYYY a objeto Date
// Versi√≥n mejorada basada en visualizerv2
function parsearFecha(fechaStr) {
    if (!fechaStr || typeof fechaStr !== 'string') return null;
    
    const partes = fechaStr.split('/');
    if (partes.length !== 3) return null;
    
    // En el JSON de eventos, sabemos que el formato es DD/MM/YYYY
    // Convertimos directamente sin intentar adivinar el formato
    const dia = parseInt(partes[0]);
    const mes = parseInt(partes[1]) - 1;  // Los meses en JS van de 0-11
    const anio = parseInt(partes[2]);
    
    // Crear la fecha
    const fecha = new Date(anio, mes, dia);
    
    // Verificar validez
    if (isNaN(fecha.getTime())) {
        console.warn(`‚ö†Ô∏è Fecha inv√°lida: ${fechaStr}`);
        return null;
    }
    
    return fecha;
}

// Funci√≥n para normalizar categor√≠as
function normalizarCategoria(categoria) {
    if (!categoria) return 'otro';
    
    const cat = categoria.toLowerCase();
    
    if (cat.includes('taller')) return 'taller';
    if (cat.includes('curso')) return 'curso';
    if (cat.includes('grupo')) return 'grupo';
    if (cat.includes('activacion') || cat.includes('activaci√≥n')) return 'activacion';
    if (cat.includes('evento')) return 'evento';
    
    return 'otro';
}

// Funci√≥n para inicializar el calendario
function inicializarCalendario() {
    try {
        console.log("üîÑ Inicializando calendario...");
        // URL del archivo JSON de eventos
        const dataUrl = 'https://karenguzmn.github.io/myb_tec/ce/eventos.json';
        
        // Mostrar estado de carga
        document.getElementById('calendario-container').innerHTML = '<div class="loading" style="grid-column: span 7;">Cargando calendario...</div>';
        document.getElementById('eventos-proximos-lista').innerHTML = '<div class="loading">Cargando eventos pr√≥ximos...</div>';
        
        // Cargar los datos desde la URL externa
        fetch(dataUrl)
            .then(response => {
                console.log(`üåê Respuesta del servidor: ${response.status} ${response.statusText}`);
                if (!response.ok) {
                    throw new Error('Error al cargar el archivo JSON');
                }
                return response.json();
            })
            .then(data => {
                console.log(`‚úÖ Datos JSON cargados correctamente`);
                
                // Guardar los datos en la variable global
                todosLosEventos = data.eventos || [];
                console.log(`üìã Se cargaron ${todosLosEventos.length} eventos`);
                
                // Convertir fechas a objetos Date para f√°cil manipulaci√≥n
                todosLosEventos.forEach(evento => {
                    evento.fechaInicioObj = parsearFecha(evento.fechaInicio);
                    evento.fechaFinObj = parsearFecha(evento.fechaFin) || evento.fechaInicioObj;
                    evento.categoria = normalizarCategoria(evento.categoria);
                    
                    // Debug de evento
                    console.log(`üîÑ Evento ${evento.id}: ${evento.titulo}`);
                    console.log(`   - Fecha inicio: ${evento.fechaInicio} -> ${evento.fechaInicioObj ? evento.fechaInicioObj.toISOString() : 'No v√°lida'}`);
                    console.log(`   - Categor√≠a: ${evento.categoria}`);
                });
                
                // Mostrar vista inicial
                generarCalendarioMes(mesActual, anioActual);
                
                // Cargar eventos pr√≥ximos
                cargarEventosProximos();
                
                console.log("üéâ Calendario inicializado correctamente");
            })
            .catch(error => {
                console.error('‚ùå Error cargando datos:', error);
                document.getElementById('calendario-container').innerHTML = `
                    <div class="error-message" style="grid-column: span 7;">
                        No se pudo cargar el calendario de eventos. Intenta m√°s tarde o contacta a Consejer√≠a Emocional para m√°s informaci√≥n.
                    </div>
                `;
                document.getElementById('eventos-proximos-lista').innerHTML = `
                    <div class="error-message">
                        No se pudo cargar los eventos pr√≥ximos. Intenta m√°s tarde o contacta a Consejer√≠a Emocional para m√°s informaci√≥n.
                    </div>
                `;
            });
        
        // Configurar eventos de navegaci√≥n con comprobaci√≥n de existencia
        const mesAnteriorBtn = document.getElementById('mes-anterior');
        if (mesAnteriorBtn) {
            mesAnteriorBtn.addEventListener('click', mesAnterior);
            console.log("‚úÖ Evento 'click' configurado para bot√≥n mes anterior");
        } else {
            console.warn("‚ö†Ô∏è Elemento 'mes-anterior' no encontrado");
        }
        
        const mesSiguienteBtn = document.getElementById('mes-siguiente');
        if (mesSiguienteBtn) {
            mesSiguienteBtn.addEventListener('click', mesSiguiente);
            console.log("‚úÖ Evento 'click' configurado para bot√≥n mes siguiente");
        } else {
            console.warn("‚ö†Ô∏è Elemento 'mes-siguiente' no encontrado");
        }
        
        // Cambios de vista
        const vistaMesBtn = document.getElementById('vista-mes');
        if (vistaMesBtn) {
            vistaMesBtn.addEventListener('click', () => cambiarVista('mes'));
            console.log("‚úÖ Evento 'click' configurado para bot√≥n vista mes");
        } else {
            console.warn("‚ö†Ô∏è Elemento 'vista-mes' no encontrado");
        }
        
        const vistaDosSemanas = document.getElementById('vista-dos-semanas');
        if (vistaDosSemanas) {
            vistaDosSemanas.addEventListener('click', () => cambiarVista('dos-semanas'));
            console.log("‚úÖ Evento 'click' configurado para bot√≥n vista dos semanas");
        } else {
            console.warn("‚ö†Ô∏è Elemento 'vista-dos-semanas' no encontrado");
        }
        
        // Configurar eventos del modal
        const modalClose = document.getElementById('modal-close');
        if (modalClose) {
            modalClose.addEventListener('click', cerrarModal);
            console.log("‚úÖ Evento 'click' configurado para cerrar modal");
        } else {
            console.warn("‚ö†Ô∏è Elemento 'modal-close' no encontrado");
        }
        
        const eventosModal = document.getElementById('eventos-modal');
        if (eventosModal) {
            eventosModal.addEventListener('click', function(e) {
                if (e.target === this) cerrarModal();
            });
            console.log("‚úÖ Evento 'click' configurado para fondo del modal");
        } else {
            console.warn("‚ö†Ô∏è Elemento 'eventos-modal' no encontrado");
        }
        
    } catch (error) {
        console.error('‚ùå Error inicializando calendario:', error);
        document.getElementById('calendario-container').innerHTML = `
            <div class="error-message" style="grid-column: span 7;">
                No se pudo cargar el calendario de eventos. Intenta m√°s tarde o contacta a Consejer√≠a Emocional para m√°s informaci√≥n.
            </div>
        `;
    }
}

// Funci√≥n para cambiar tipo de vista
function cambiarVista(vista) {
    console.log(`üîÑ Cambiando vista a: ${vista}`);
    vistaActual = vista;
    
    // Actualizar clases en botones
    const vistaMesBtn = document.getElementById('vista-mes');
    const vistaDosSemanas = document.getElementById('vista-dos-semanas');
    
    if (vistaMesBtn) {
        vistaMesBtn.classList.toggle('activo', vista === 'mes');
    }
    
    if (vistaDosSemanas) {
        vistaDosSemanas.classList.toggle('activo', vista === 'dos-semanas');
    }
    
    // Regenerar vista
    if (vista === 'mes') {
        generarCalendarioMes(mesActual, anioActual);
    } else {
        generarCalendarioDosSemanasDesde(new Date(anioActual, mesActual, 1));
    }
}

// Funci√≥n para generar el calendario de un mes completo
function generarCalendarioMes(mes, anio) {
    console.log(`üóìÔ∏è Generando calendario para ${nombresMeses[mes]} ${anio}`);
    
    // Actualizar el t√≠tulo
    const mesActualEl = document.getElementById('calendario-mes-actual');
    if (mesActualEl) {
        mesActualEl.textContent = `${nombresMeses[mes]} ${anio}`;
    }
    
    const periodoActualEl = document.getElementById('periodo-actual-texto');
    if (periodoActualEl) {
        periodoActualEl.textContent = `${nombresMeses[mes]} ${anio}`;
    }
    
    const contenedor = document.getElementById('calendario-container');
    if (!contenedor) {
        console.error("‚ùå Contenedor del calendario no encontrado");
        return;
    }
    
    // Limpiar contenedor excepto la fila de encabezados
    while (contenedor.childNodes.length > 1) {
        contenedor.removeChild(contenedor.lastChild);
    }
    
    // Primer d√≠a del mes
    const primerDia = new Date(anio, mes, 1);
    // D√≠a de la semana (0: domingo, 1: lunes, ..., 6: s√°bado)
    const primerDiaSemana = primerDia.getDay();
    
    // √öltimo d√≠a del mes
    const ultimoDia = new Date(anio, mes + 1, 0).getDate();
    
    // √öltimo d√≠a del mes anterior
    const ultimoDiaMesAnterior = new Date(anio, mes, 0).getDate();
    
    // Fecha actual
    const hoy = new Date();
    const esHoyMesActual = hoy.getMonth() === mes && hoy.getFullYear() === anio;
    
    // Calcular n√∫mero de semanas necesarias
    const diasPrimeraSemana = 7 - primerDiaSemana;
    const diasRestantes = ultimoDia - diasPrimeraSemana;
    const semanasAdicionales = Math.ceil(diasRestantes / 7);
    const totalSemanas = 1 + semanasAdicionales;
    
    // Generar cada semana
    let diaActual = 1;
    
    for (let i = 0; i < totalSemanas; i++) {
        const semanaNodo = document.createElement('div');
        semanaNodo.className = 'calendario-semana';
        
        for (let j = 0; j < 7; j++) {
            const diaCelda = document.createElement('div');
            diaCelda.className = 'calendario-day';
            
            let fecha;
            let esOtroMes = false;
            
            // D√≠as del mes anterior
            if (i === 0 && j < primerDiaSemana) {
                const diaAnterior = ultimoDiaMesAnterior - primerDiaSemana + j + 1;
                fecha = new Date(anio, mes - 1, diaAnterior);
                esOtroMes = true;
            }
            // D√≠as del mes siguiente
            else if (diaActual > ultimoDia) {
                const diaSiguiente = diaActual - ultimoDia;
                fecha = new Date(anio, mes + 1, diaSiguiente);
                diaActual++;
                esOtroMes = true;
            }
            // D√≠as del mes actual
            else {
                fecha = new Date(anio, mes, diaActual);
                diaActual++;
            }
            
            // A√±adir clase para otros meses
            if (esOtroMes) {
                diaCelda.classList.add('other-month');
            }
            
            // Marcar el d√≠a de hoy
            if (esHoyMesActual && fecha.getDate() === hoy.getDate() && !esOtroMes) {
                diaCelda.classList.add('today');
            }
            
            // Verificar si hay eventos este d√≠a
            const eventosDelDia = obtenerEventosDelDia(fecha);
            
            if (eventosDelDia.length > 0) {
                diaCelda.classList.add('has-eventos');
                
                // A√±adir evento click
                diaCelda.addEventListener('click', function() {
                    mostrarEventosDelDia(fecha);
                });
                
                console.log(`‚úÖ D√≠a ${fecha.getDate()}/${fecha.getMonth()+1}/${fecha.getFullYear()} tiene ${eventosDelDia.length} eventos`);
            }
            
            // N√∫mero del d√≠a
            const diaNumero = document.createElement('div');
            diaNumero.className = 'calendario-day-number';
            diaNumero.textContent = fecha.getDate();
            diaCelda.appendChild(diaNumero);
            
            // Indicadores de eventos
            if (eventosDelDia.length > 0) {
                const dotsContainer = document.createElement('div');
                dotsContainer.className = 'calendario-day-eventos';
                
                // Agrupar por categor√≠a para mostrar solo un indicador por tipo
                const categorias = new Set();
                eventosDelDia.forEach(evento => categorias.add(evento.categoria));
                
                // Limitar a 4 indicadores
                const categoriasArray = Array.from(categorias);
                const maxDots = Math.min(categoriasArray.length, 4);
                
                for (let k = 0; k < maxDots; k++) {
                    const dot = document.createElement('div');
                    dot.className = `evento-dot ${categoriasArray[k]}`;
                    dotsContainer.appendChild(dot);
                }
                
                diaCelda.appendChild(dotsContainer);
            }
            
            semanaNodo.appendChild(diaCelda);
        }
        
        contenedor.appendChild(semanaNodo);
    }
    
    console.log("‚úÖ Calendario generado correctamente");
}

// Funci√≥n para generar vista de dos semanas
function generarCalendarioDosSemanasDesde(fechaInicio) {
    console.log(`üóìÔ∏è Generando vista de dos semanas desde ${fechaInicio.toLocaleDateString()}`);
    
    // Ajustar la fecha de inicio al domingo de esa semana
    const inicioSemana = new Date(fechaInicio);
    const diaSemana = inicioSemana.getDay(); // 0=domingo, 1=lunes, ..., 6=s√°bado
    inicioSemana.setDate(inicioSemana.getDate() - diaSemana);
    
    // Actualizar el t√≠tulo
    const fechaFin = new Date(inicioSemana);
    fechaFin.setDate(inicioSemana.getDate() + 13); // 14 d√≠as (2 semanas)
    
    const mesActualEl = document.getElementById('calendario-mes-actual');
    if (mesActualEl) {
        if (inicioSemana.getMonth() !== fechaFin.getMonth()) {
            mesActualEl.textContent = 
                `${nombresMeses[inicioSemana.getMonth()]} - ${nombresMeses[fechaFin.getMonth()]} ${fechaFin.getFullYear()}`;
        } else {
            mesActualEl.textContent = 
                `${nombresMeses[inicioSemana.getMonth()]} ${inicioSemana.getFullYear()}`;
        }
    }
    
    const periodoActualEl = document.getElementById('periodo-actual-texto');
    if (periodoActualEl) {
        periodoActualEl.textContent = 
            `${formatShortDate(inicioSemana)} al ${formatShortDate(fechaFin)}`;
    }
    
    const contenedor = document.getElementById('calendario-container');
    if (!contenedor) {
        console.error("‚ùå Contenedor del calendario no encontrado");
        return;
    }
    
    // Limpiar contenedor excepto la fila de encabezados
    while (contenedor.childNodes.length > 1) {
        contenedor.removeChild(contenedor.lastChild);
    }
    
    // Generar las dos semanas
    for (let semana = 0; semana < 2; semana++) {
        const semanaNodo = document.createElement('div');
        semanaNodo.className = 'calendario-semana';
        
        for (let dia = 0; dia < 7; dia++) {
            const fechaDia = new Date(inicioSemana);
            fechaDia.setDate(inicioSemana.getDate() + (semana * 7) + dia);
            
            const diaCelda = document.createElement('div');
            diaCelda.className = 'calendario-day';
            
            // Verificar si es otro mes
            if (fechaDia.getMonth() !== mesActual) {
                diaCelda.classList.add('other-month');
            }
            
            // Verificar si es hoy
            const hoy = new Date();
            if (fechaDia.getDate() === hoy.getDate() && 
                fechaDia.getMonth() === hoy.getMonth() && 
                fechaDia.getFullYear() === hoy.getFullYear()) {
                diaCelda.classList.add('today');
            }
            
            // Verificar si hay eventos este d√≠a
            const eventosDelDia = obtenerEventosDelDia(fechaDia);
            if (eventosDelDia.length > 0) {
                diaCelda.classList.add('has-eventos');
                
                // A√±adir evento click
                diaCelda.addEventListener('click', function() {
                    mostrarEventosDelDia(fechaDia);
                });
                
                console.log(`‚úÖ D√≠a ${fechaDia.getDate()}/${fechaDia.getMonth()+1}/${fechaDia.getFullYear()} tiene ${eventosDelDia.length} eventos`);
            }
            
            // N√∫mero del d√≠a
            const diaNumero = document.createElement('div');
            diaNumero.className = 'calendario-day-number';
            diaNumero.textContent = fechaDia.getDate();
            diaCelda.appendChild(diaNumero);
            
            // Indicadores de eventos
            if (eventosDelDia.length > 0) {
                const dotsContainer = document.createElement('div');
                dotsContainer.className = 'calendario-day-eventos';
                
                // Agrupar por categor√≠a para mostrar solo un indicador por tipo
                const categorias = new Set();
                eventosDelDia.forEach(evento => categorias.add(evento.categoria));
                
                // Limitar a 4 indicadores
                const categoriasArray = Array.from(categorias);
                const maxDots = Math.min(categoriasArray.length, 4);
                
                for (let k = 0; k < maxDots; k++) {
                    const dot = document.createElement('div');
                    dot.className = `evento-dot ${categoriasArray[k]}`;
                    dotsContainer.appendChild(dot);
                }
                
                diaCelda.appendChild(dotsContainer);
            }
            
            semanaNodo.appendChild(diaCelda);
        }
        
        contenedor.appendChild(semanaNodo);
    }
    
    console.log("‚úÖ Vista de dos semanas generada correctamente");
}

// Funci√≥n para obtener eventos de un d√≠a espec√≠fico - CORREGIDA
function obtenerEventosDelDia(fecha) {
    if (!fecha || !todosLosEventos || todosLosEventos.length === 0) return [];
    
    // Establecer la fecha a comparar a inicio del d√≠a
    const fechaComparar = new Date(fecha);
    fechaComparar.setHours(0, 0, 0, 0);
    
    // Antes de filtrar, verifiquemos si faltan fechas
    const eventosSinFecha = todosLosEventos.filter(e => !e.fechaInicioObj);
    if (eventosSinFecha.length > 0) {
        console.warn(`‚ö†Ô∏è Hay ${eventosSinFecha.length} eventos sin fechaInicioObj v√°lida`);
    }
    
    return todosLosEventos.filter(evento => {
        if (!evento.fechaInicioObj) {
            return false;
        }
        
        // Normalizar fechas de evento
        const fechaInicio = new Date(evento.fechaInicioObj);
        fechaInicio.setHours(0, 0, 0, 0);
        
        const fechaFin = evento.fechaFinObj ? new Date(evento.fechaFinObj) : new Date(fechaInicio);
        fechaFin.setHours(0, 0, 0, 0);
        
        // Verificar si la fecha est√° entre el inicio y fin del evento
        const result = esMismaFecha(fechaInicio, fechaComparar) || 
                 esMismaFecha(fechaFin, fechaComparar) || 
                 (fechaInicio <= fechaComparar && fechaComparar <= fechaFin);
                 
        // Si coincide, haz debug
        if (result) {
            console.log(`üìå Evento ${evento.id} (${evento.titulo}) coincide con fecha ${fechaComparar.toLocaleDateString()}`);
            console.log(`   - fechaInicio: ${fechaInicio.toLocaleDateString()}`);
            console.log(`   - fechaFin: ${fechaFin.toLocaleDateString()}`);
        }
        
        return result;
    });
}

// Funci√≥n para verificar si dos fechas son el mismo d√≠a
function esMismaFecha(fecha1, fecha2) {
    if (!fecha1 || !fecha2) return false;
    
    return fecha1.getDate() === fecha2.getDate() &&
           fecha1.getMonth() === fecha2.getMonth() &&
           fecha1.getFullYear() === fecha2.getFullYear();
}

// Funci√≥n para cargar eventos pr√≥ximos - MEJORADA
function cargarEventosProximos() {
    console.log("üîÑ Cargando eventos pr√≥ximos...");
    
    const container = document.getElementById('eventos-proximos-lista');
    if (!container) {
        console.error("‚ùå Contenedor de eventos pr√≥ximos no encontrado");
        return;
    }
    
    // Obtener eventos futuros ordenados por fecha
    const hoy = new Date();
    hoy.setHours(0, 0, 0, 0);
    
    // Filtro mejorado para eventos futuros
    const eventosFuturos = todosLosEventos
        .filter(evento => {
            if (!evento.fechaInicioObj) return false;
            const fechaEvento = new Date(evento.fechaInicioObj);
            fechaEvento.setHours(0, 0, 0, 0);
            return fechaEvento >= hoy;
        })
        .sort((a, b) => a.fechaInicioObj - b.fechaInicioObj);
    
    console.log(`üìã Se encontraron ${eventosFuturos.length} eventos futuros`);
    
    // Si no hay eventos futuros
    if (eventosFuturos.length === 0) {
        container.innerHTML = `
            <div class="no-eventos">
                No hay eventos programados pr√≥ximamente.
            </div>
        `;
        return;
    }
    
    // Mostrar los pr√≥ximos eventos (m√°ximo 5)
    container.innerHTML = '';
    
    const maxEventos = Math.min(eventosFuturos.length, 5);
    for (let i = 0; i < maxEventos; i++) {
        const evento = eventosFuturos[i];
        
        // Determinar la clase CSS seg√∫n el tipo de evento
        let eventoClass = 'evento-item';
        let badgeClass = 'evento-badge';
        
        eventoClass += ` ${evento.categoria}`;
        badgeClass += ` ${evento.categoria}`;
        
        // Formatear fecha
        const fechaFormateada = formatDate(evento.fechaInicioObj, false);
        
        const eventoHTML = `
            <div class="${eventoClass}">
                <div class="evento-fecha">${fechaFormateada}</div>
                <div class="evento-titulo">
                    ${evento.titulo || 'Evento sin t√≠tulo'}
                    <span class="${badgeClass}">${capitalizarPrimera(evento.categoria)}</span>
                </div>
                <div class="evento-detalles">
                    <div class="evento-horario">
                        <span>‚è∞</span> ${evento.horario || 'Horario no especificado'}
                    </div>
                    <div class="evento-ubicacion">
                        <span>üìç</span> ${evento.ubicacion || evento.ubicaci√≥n || 'Por definir'}
                    </div>
                </div>
                <div class="evento-acciones">
                    ${evento.urlRegistro ? 
                        `<a href="${evento.urlRegistro}" target="_blank" class="btn-accion registro">
                            <span>‚úçÔ∏è</span> Inscribirme
                        </a>` : ''}
                    <button class="btn-accion" onclick="agregarACalendario(${evento.id})">
                        <span>üìÖ</span> Agregar a calendario
                    </button>
                </div>
            </div>
        `;
        
        container.innerHTML += eventoHTML;
    }
    
    console.log("‚úÖ Eventos pr√≥ximos cargados correctamente");
}

// Funci√≥n para mostrar los eventos de un d√≠a en el modal
function mostrarEventosDelDia(fecha) {
    console.log(`üîç Mostrando eventos para el d√≠a ${fecha.toLocaleDateString()}`);
    
    // Obtener eventos para esta fecha
    const eventos = obtenerEventosDelDia(fecha);
    
    if (eventos.length === 0) {
        console.log("‚ö†Ô∏è No hay eventos para esta fecha");
        return;
    }
    
    console.log(`üìã Encontrados ${eventos.length} eventos para mostrar en el modal`);
    
    // Actualizar t√≠tulo del modal con la fecha formateada
    const modalFecha = document.getElementById('modal-fecha');
    if (modalFecha) {
        modalFecha.textContent = `Eventos para el ${formatDate(fecha)}`;
    }
    
    // Limpiar y llenar la lista de eventos
    const modalEventos = document.getElementById('modal-eventos');
    if (!modalEventos) {
        console.error("‚ùå Contenedor de eventos del modal no encontrado");
        return;
    }
    
    modalEventos.innerHTML = '';
    
    eventos.forEach(evento => {
        // Determinar la clase CSS seg√∫n el tipo de evento
        let eventoClass = 'evento-item';
        let badgeClass = 'evento-badge';
        
        eventoClass += ` ${evento.categoria}`;
        badgeClass += ` ${evento.categoria}`;
        
        const eventoHTML = `
            <div class="${eventoClass}">
                <div class="evento-titulo">
                    ${evento.titulo || 'Evento sin t√≠tulo'}
                    <span class="${badgeClass}">${capitalizarPrimera(evento.categoria)}</span>
                </div>
                <div class="evento-detalles">
                    <div class="evento-horario">
                        <span>‚è∞</span> ${evento.horario || 'Horario por definir'}
                    </div>
                    <div class="evento-ubicacion">
                        <span>üìç</span> ${evento.ubicacion || evento.ubicaci√≥n || 'Ubicaci√≥n por definir'}
                    </div>
                </div>
                <div class="evento-descripcion">
                    ${evento.descripcion || 'Sin descripci√≥n disponible'}
                </div>
                <div class="evento-info-adicional">
                    <strong>Duraci√≥n:</strong> ${evento.duracion || 'No especificada'}
                </div>
                <div class="evento-info-adicional">
                    <strong>Modalidad:</strong> ${evento.modalidad || 'No especificada'}
                </div>
                <div class="evento-acciones">
                    ${evento.urlRegistro ? 
                        `<a href="${evento.urlRegistro}" target="_blank" class="btn-accion registro">
                            <span>‚úçÔ∏è</span> Inscribirme
                        </a>` : ''}
                    <button class="btn-accion" onclick="agregarACalendario(${evento.id})">
                        <span>üìÖ</span> Agregar a calendario
                    </button>
                </div>
            </div>
        `;
        
        modalEventos.innerHTML += eventoHTML;
    });
    
    // Mostrar el modal
    const eventosModal = document.getElementById('eventos-modal');
    if (eventosModal) {
        eventosModal.style.display = 'flex';
    } else {
        console.error("‚ùå Modal de eventos no encontrado");
    }
}

// Funci√≥n para agregar evento al calendario del usuario
function agregarACalendario(eventoId) {
    console.log(`üîÑ Intentando agregar evento ${eventoId} al calendario`);
    
    const evento = todosLosEventos.find(e => e.id === eventoId);
    if (!evento) {
        console.error(`‚ùå Evento con ID ${eventoId} no encontrado`);
        return;
    }
    
    try {
        // Crear fechas para el evento
        const fechaInicio = evento.fechaInicioObj;
        let fechaFin = evento.fechaFinObj || new Date(fechaInicio);
        
        // Si es el mismo d√≠a, agregar 1 hora por defecto
        if (esMismaFecha(fechaInicio, fechaFin)) {
            fechaFin = new Date(fechaInicio);
            fechaFin.setHours(fechaInicio.getHours() + 1);
        }
        
        // Formatear fechas para ICS
        const formatoFechaICS = function(fecha) {
            // Asegurar que la fecha tenga zona horaria UTC
            return fecha.toISOString().replace(/-|:|\.\d+/g, '');
        };
        
        // Crear contenido ICS
        const contenidoICS = [
            'BEGIN:VCALENDAR',
            'VERSION:2.0',
            'PRODID:-//Consejer√≠a Emocional//Eventos//ES',
            'CALSCALE:GREGORIAN',
            'METHOD:PUBLISH',
            'BEGIN:VEVENT',
            `UID:${evento.id}@visualizador-eventos`,
            `DTSTAMP:${formatoFechaICS(new Date())}`,
            `DTSTART:${formatoFechaICS(fechaInicio)}`,
            `DTEND:${formatoFechaICS(fechaFin)}`,
            `SUMMARY:${evento.titulo}`,
            `DESCRIPTION:${evento.descripcion || 'Sin descripci√≥n'}`,
            `LOCATION:${evento.ubicacion || evento.ubicaci√≥n || 'Por definir'}`,
            'END:VEVENT',
            'END:VCALENDAR'
        ].join('\r\n');
        
        // Crear blob y URL
        const blob = new Blob([contenidoICS], { type: 'text/calendar;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        
        // Crear enlace y simular clic
        const link = document.createElement('a');
        link.href = url;
        link.download = `evento_${evento.id}.ics`;
        document.body.appendChild(link);
        link.click();
        
        // Limpiar
        setTimeout(() => {
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }, 100);
        
        alert('Evento a√±adido a tu calendario');
        console.log("‚úÖ Evento agregado al calendario correctamente");
    } catch (error) {
        console.error('‚ùå Error al generar/descargar ICS:', error);
        alert('Error al a√±adir evento al calendario');
    }
}

// Funci√≥n para cerrar el modal
function cerrarModal() {
    const eventosModal = document.getElementById('eventos-modal');
    if (eventosModal) {
        eventosModal.style.display = 'none';
    }
}

// Navegar al mes anterior
function mesAnterior() {
    console.log("üîÑ Navegando al mes anterior");
    mesActual--;
    if (mesActual < 0) {
        mesActual = 11;
        anioActual--;
    }
    
    if (vistaActual === 'mes') {
        generarCalendarioMes(mesActual, anioActual);
    } else {
        generarCalendarioDosSemanasDesde(new Date(anioActual, mesActual, 1));
    }
}

// Navegar al mes siguiente
function mesSiguiente() {
    console.log("üîÑ Navegando al mes siguiente");
    mesActual++;
    if (mesActual > 11) {
        mesActual = 0;
        anioActual++;
    }
    
    if (vistaActual === 'mes') {
        generarCalendarioMes(mesActual, anioActual);
    } else {
        generarCalendarioDosSemanasDesde(new Date(anioActual, mesActual, 1));
    }
}

// Funci√≥n para capitalizar la primera letra
function capitalizarPrimera(texto) {
    if (!texto) return '';
    return texto.charAt(0).toUpperCase() + texto.slice(1);
}

// Exponer funci√≥n de agregar a calendario globalmente
window.agregarACalendario = agregarACalendario;

// Inicializar el componente cuando el DOM est√© listo
document.addEventListener('DOMContentLoaded', inicializarCalendario);
